# 測試覆蓋率報告

## 當前覆蓋率狀態

### 總體覆蓋率
- **當前**: ~62%
- **目標**: 70-80%
- **差距**: 需要提升 8-18%

### 各模組覆蓋率詳情

| 模組 | 語句數 | 未覆蓋 | 覆蓋率 | 狀態 |
|------|--------|--------|--------|------|
| `ai_core/logger.py` | 73 | 6 | **92%** | ✅ 優秀 |
| `backend/database.py` | 172 | 27 | **84%** | ✅ 良好 |
| `backend/main.py` | 557 | 191 | **66%** | ⚠️ 需改進 |
| `ai_core/processor.py` | 926 | 431 | **53%** | ⚠️ 需改進 |
| `ai_core/worker.py` | 78 | 78 | **0%** | ❌ 未測試 |
| **總計** | **1806** | **733** | **62%** | ⚠️ 接近目標 |

## 未覆蓋的主要區域

### backend/main.py (66% 覆蓋率)
**未覆蓋的行數**: 154-181, 205, 220, 229-231, 246-247, 250, 259, 278, 280, 283-305, 455, 470, 479-480, 488-489, 494-498, 502-506, 594-595, 599, 608-621, 656-661, 695, 699, 719-733, 741-742, 745-749, 791-793, 809-943, 973-1041, 1044-1045

**主要未覆蓋功能**:
- `scan_existing_videos()` 的部分邏輯（283-305行）
- `migrate_json_to_sqlite()` 的部分邏輯（154-181行）
- WebSocket 端點的完整流程（809-943, 973-1041行）
- 視頻播放的 Range 請求處理（608-621行）
- 錯誤處理路徑

### ai_core/processor.py (53% 覆蓋率)
**未覆蓋的行數**: 21-23, 43-45, 53-54, 86, 90, 94, 98, 127, 136, 145, 154-157, 175-214, 242-244, 266, 297-299, 329, 338-342, 434-445, 494-627, 653-655, 660-684, 689-709, 714-717, 736-738, 744, 758-875, 937-945, 971, 976, 991-997, 1001-1017, 1022-1024, 1059-1061, 1096, 1112, 1122-1123, 1142-1153, 1169, 1218, 1232, 1263-1267, 1275, 1291-1292, 1341-1342, 1350-1354, 1400-1442, 1494, 1563-1598, 1616-1621, 1626-1633, 1641-1670, 1684-1687, 1690, 1713, 1726-1747, 1755-1758, 1765, 1770-1771, 1776, 1780-1800, 1807-1823, 1847-1865, 1868

**主要未覆蓋功能**:
- `detect_ball()` 中的 ONNX 模型路徑（175-214行）
- `analyze_video()` 中的大量邏輯（1563-1868行）
  - 動作合併算法
  - 回合檢測
  - 遊戲狀態檢測
  - 分數檢測
- `_detect_jersey_number_yolo()` 的完整實現（758-875行）
- `_detect_jersey_number_ocr()` 的完整實現（937-945行）
- 各種檢測方法的錯誤處理路徑

## 測試統計

### 測試執行結果
- **通過**: 186 個測試
- **失敗**: 9 個測試
- **跳過**: 1 個測試
- **總計**: 196 個測試

### 測試文件
- `test_database.py` - 數據庫測試
- `test_logger.py` - 日誌測試
- `test_main.py` - API 端點測試
- `test_main_extended_coverage.py` - 擴展 API 測試
- `test_processor.py` - 處理器測試
- `test_processor_extended_coverage.py` - 擴展處理器測試
- `test_integration.py` - 集成測試

## 達到 70% 覆蓋率的建議

### 優先級 1: 提升 processor.py 覆蓋率（目標: 60%+）
1. **添加 analyze_video 完整測試**
   - 測試動作合併邏輯
   - 測試回合檢測
   - 測試遊戲狀態檢測
   - 測試分數檢測

2. **添加檢測方法的完整流程測試**
   - `detect_ball()` 的 ONNX 路徑
   - `_detect_jersey_number_yolo()` 的完整實現
   - `_detect_jersey_number_ocr()` 的完整實現

### 優先級 2: 提升 main.py 覆蓋率（目標: 75%+）
1. **添加 WebSocket 完整流程測試**
   - 測試完整的分析流程
   - 測試進度更新
   - 測試錯誤處理

2. **添加 scan_existing_videos 完整測試**
   - 測試各種文件掃描場景
   - 測試結果文件恢復

3. **添加視頻播放 Range 請求測試**
   - 測試各種 Range 請求格式

### 優先級 3: 修復失敗的測試
- 修復 9 個失敗的測試
- 確保所有測試都能通過

## 運行覆蓋率報告

```bash
# 激活虛擬環境
source venv/bin/activate

# 運行所有測試並生成覆蓋率報告
pytest tests/ --cov=backend --cov=ai_core --cov-report=term-missing --cov-report=html

# 查看 HTML 報告
open htmlcov/index.html
```

## 結論

當前覆蓋率為 **62%**，距離目標 **70-80%** 還差 **8-18%**。

主要改進方向：
1. ✅ 已添加大量測試（+50+ 個新測試）
2. ⚠️ 需要添加更多 `analyze_video` 的測試
3. ⚠️ 需要添加更多 WebSocket 流程測試
4. ⚠️ 需要修復失敗的測試

通過繼續添加測試和修復失敗的測試，預計可以達到 **70%+** 的覆蓋率。

